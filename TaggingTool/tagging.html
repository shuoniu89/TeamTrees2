<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>

  <!--    COLORS AND FONTS-->

  <style>

    body {
      font-family: sans-serif;
      background: #85B1EC;
      font-size:15px
    }

    h2 {
      margin: 5px 0;font-size:20px;
    }

    h3 {
      margin: 5px; font-size:15px;
    }

    #wrapper {
      width: 980px;
      margin: 0 auto;
      background: white;
      padding: 10px 15px;
      border-radius: 10px;
    }

    input {
      margin: 5px 10px;
    }

    button {
      font-size: 15px;
      padding: 10px;
      margin: 20px 0;
      color: white;
      border: 0;
      border-radius: 10px;
      border-bottom: 3px solid #333;
    }


    #submit {
      background: green;
    }

    #download {
      background: cornflowerblue;
    }

    #answer {
      border: 1px dashed #ccc;
      background: #eee;
      padding: 10px;
    }

    .videoWrapper {
      display: flex;
      justify-content: center;
      vertical-align: top;
    }

    .iframe {
      width: 800px;
    }

    html,body {padding:0;margin:0;}
    .wrap {
      font:13px Arial, san-serif;
    }

  </style>

  <!--BUTTONS AND QUESTIONS-->

  <script src="https://d3js.org/d3.v4.js" charset="utf-8"></script>
  <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
</head>
<body>
<div class="videoWrapper">
  <iframe id="videoframe" width="640" height="360" src="https://www.youtube.com/embed/"
  ></iframe>
</div>
<div id="wrapper">
  <!--    <input type="button" id="button2" value="Display your progress" onclick="display_array();"></input>-->
  <h2>Video tagging tool</h2>
  <label for="uploadTaggedFile" style = "font-size:15px;">Upload your progress (optional):</label>
  <input type ="file" accept=".csv" value = "Upload progress file" style="margin: 5px;" id="uploadTaggedFile">
  <br/>
  <label for="uploadVideoFile" style = "font-size:15px;">Upload video data set (required):</label>
  <input type="file" accept=".csv" value = "Upload data file" style="margin: 5px;" id="uploadVideoFile">
  <br/><br/>
  <label for="title" style="font-style: italic">Title:</label>
  <a href="#" id="link" target="_blank"> <h2 id="title" style="font-size:20px"></h2> </a>
  <label for="viewCount" style="font-style: italic">Views:</label>
  <h2 id="viewCount" style="font-size:20px"></h2>
  <br/>
  <div class="wrap">
    <form action="">

      <br/>
      <!--QUESTION 0-->
      <div id="q0">
        <h3>Should we include this video? "No" includes non-English videos, private/deleted videos, etc.
        If you select No, you can go directly to Save answers and Next at the end of the page.</h3>
        <label><input type="radio" name="q0"  class="radio" value="true">
          Yes
        </label><br/>
        <label><input type="radio" name="q0"  class="radio" value="false">
          No
        </label>
      </div>
      </br>

      <h3 style="font-style:italic;font-size:15px;font-weight: normal;">DIAGNOSTIC TABLE</h3>
      <input type="button" value="Show/hide table" onclick="hideImage('diagnostic_img');">
      <img id="diagnostic_img" src="https://i.imgur.com/ssRHx21.png" height = "auto" width="900" style = "display:block;"/>
      <br/>
      <br/>

      <!-- QUESTION 1 -->
      <div id="q1">
        <h3>What is the diagnostic/problem being framed? Check all that apply.</h3>
        <label><input type="checkbox" name="q1" class="checkbox" value="climate change">
          Climate change
        </label><br/>
        <label><input type="checkbox" name="q1"  class="checkbox" value="deforestation">
          Deforestation
        </label><br/>
        <label><input type="checkbox" name="q1"  class="checkbox" value="inaction">
          Inaction
        </label><br/>
        <label><input type="checkbox" name="q1"  class="checkbox" value="other issues">
          Other issues
        </label><br/>
        <label><input type="checkbox" name="q1"  class="checkbox" value="none_apply">
          None of the options is apparent.
        </label>
      </div>

      </br>
      <h3 style="font-style:italic;font-size:15px;font-weight: normal;">PROGNOSTIC TABLE</h3>
      <input type="button" value="Show/hide table" onclick="hideImage('prognostic_img');">
      <img id="prognostic_img" src="https://i.imgur.com/EXuTf7S.png" height = "auto" width="900" style = "display:block;"/>
      <br/>
      <br/>

      <!-- QUESTION 2 -->
      <div id="q2">
        <h3>What does this video try to do? If the video has a MAIN theme,
          please only check the main theme. If there are multiple main themes, check all that apply.</h3>
        <label><input type="checkbox" name="q2" class="checkbox" value="spread the word">
          Spread the word
        </label><br/>
        <label><input type="checkbox" name="q2"  class="checkbox" value="environmental discussion">
          Environmental discussion
        </label><br/>
        <label><input type="checkbox" name="q2"  class="checkbox" value="shoutout">
          Shout-out
        </label><br/>
        <label><input type="checkbox" name="q2"  class="checkbox" value="share videos">
          Share videos
        </label><br/>
        <label><input type="checkbox" name="q2" class="checkbox" value="donation">
          Donation
        </label><br/>
        <label><input type="checkbox" name="q2"  class="checkbox" value="plant trees">
          Plant trees
        </label><br/>
        <label><input type="checkbox" name="q2"  class="checkbox" value="knowledge">
          Knowledge
        </label><br/>
        <label><input type="checkbox" name="q2"  class="checkbox" value="gameplay">
          Gameplay
        </label><br/>
        <label><input type="checkbox" name="q2"  class="checkbox" value="creation">
          Creation
        </label><br/>
        <label><input type="checkbox" name="q2"  class="checkbox" value="criticism">
          Criticism
        </label><br/>
        <label><input type="checkbox" name="q2"  class="checkbox" value="none_apply">
          None of the options is apparent.
        </label>
      </div>

      </br>
      <h3 style="font-style:italic;font-size:15px;font-weight: normal;">MOTIVATIONAL TABLE</h3>
      <input type="button" value="Show/hide table" onclick="hideImage('motivational_img');">
      <img id="motivational_img" src="https://i.imgur.com/8aV2ptZ.png" height = "auto" width="900" style = "display:block;"/>
      <br/>
      <br/>

      <!-- QUESTION 3 -->
      <div id="q3">
        <h3>What/How does the video motivate viewers to participate? Check all that apply.</h3>
        <label><input type="checkbox" name="q3" class="checkbox" value="donation">
          Donation
        </label><br/>
        <label><input type="checkbox" name="q3"  class="checkbox" value="environmental actions">
          Environmental actions
        </label><br/>
        <label><input type="checkbox" name="q3"  class="checkbox" value="join activities">
          Join activities
        </label><br/>
        <label><input type="checkbox" name="q3"  class="checkbox" value="more trees">
          More trees
        </label><br/>
        <label><input type="checkbox" name="q3" class="checkbox" value="tree benefits">
          Tree benefits
        </label><br/>
        <label><input type="checkbox" name="q3"  class="checkbox" value="celebrity effect">
          Celebrity effect
        </label><br/>
        <label><input type="checkbox" name="q3"  class="checkbox" value="community effect">
          Community effect
        </label><br/>
        <label><input type="checkbox" name="q3"  class="checkbox" value="none_apply">
          None of the options is apparent.
        </label>
      </div>

    </form>
  </div>
  <br/><br/>
  <button type="submit" id="submit" onclick="isCompleted()">Save answers & Next</button>
  <button type="download" id="download" onclick='downloadCSV({ filename: "progress.csv" });'>Finish & Download</button>
  <label for="totalVideosTagged" style="font-style: italic">Total videos tagged: </label>
  <text id="totalVideosTagged" style="font-size:20px"></text>
  <h3 style="margin: 1px;font-size:15px;font-style: italic">After Finish & Download, move the progress.csv file to the Tagging_Tool folder to import your progress later.</h3>
</div>


<script type="application/javascript">
  let url_list = [];
  let currentIndex = 0;
  let answers = [];
  let totalTagged = 0;
  let continuing = false;
  let NUMBER_OF_QUESTIONS  = 4;
  let FINAL_HEADER = ["isIncluded", "diagnostic", "prognostic", "motivational"];

  document.getElementById('uploadTaggedFile').addEventListener('change',loadTaggedFile);
  document.getElementById('uploadVideoFile').addEventListener('change', loadVideoFile);

  // CLEAR QUESTION CHECKBOXES
  clearAnswers();

  // hide or show image
  function hideImage(img) {
    let x = document.getElementById(img);
    if (x.style.display === "block") {
      x.style.display = "none_apply";
    } else {
      x.style.display = "block";
    }
  }

  // LOAD TAGGED FILE
  function loadTaggedFile(evt) {
    let file = evt.target.files[0];
    if (file) {
      continuing = true;
      let reader = new FileReader();
      reader.onloadend = function (evt) {
        let dataUrl = evt.target.result;
        // The following call results in an "Access denied" error in IE.
        storeTaggedVid(dataUrl);
      };
      reader.readAsDataURL(file);
    }
  }

  // STORE TAGGED VIDEO DATA
  let storeTaggedVid = function (csvUrl) { // argument = video Url
    d3.csv(csvUrl, function (rows) {
      rows.forEach(function (d) { // for each row in the csv
        answers.push({
          "embedUrl": d["embedUrl"],
          "videoId": d["videoId"],
          "isIncluded" : d["isIncluded"],
          "diagnostic":d["diagnostic"],
          "prognostic":d["prognostic"],
          "motivational":d["motivation"]
        });
        totalTagged++;
      });
    });
  };

  // LOAD VIDEO FILE
  function loadVideoFile(evt) {
    url_list = [];
    currentIndex = 0;
    let file = evt.target.files[0];
    if (file) {
      let reader = new FileReader();
      reader.onloadend = function (evt) {
        let dataUrl = evt.target.result;
        // The following call results in an "Access denied" error in IE.
        previewCsvUrl(dataUrl);
      };
      reader.readAsDataURL(file);
      clearAnswers();
    }
  }

  let previewCsvUrl = function (csvUrl) { // argument = csv Url
    d3.csv(csvUrl, function (rows) {
      rows.forEach(function (d) { // for each row in the csv
        let tagged = isTagged(d["embedUrl"]); //check to see if vid has been tagged
        if(!tagged){
          url_list.push({
            "embedUrl": d["embedUrl"],
            "videoId": d["videoId"],
            "viewCount":d["viewCount"],
            "title": d["title"],
          });
        }
      });
      updateVideoUrl(currentIndex);
      clearAnswers();
    });
  };

  function isTagged(url) {
    list = answers
    let tagged = false;
    if(continuing) {
      for (let i = 0, l = list.length; i < l; i++) {
        if (list[i]["embedUrl"] === url) {
          tagged = true;
          break;
        }
      }
    }
    return tagged;
  }

  function updateVideoUrl(index) {
    if (index < url_list.length) {
      document.getElementById("videoframe").setAttribute("src", url_list[index]["embedUrl"]);
      document.getElementById("link").href=url_list[index]["embedUrl"];
      document.getElementById("title").innerText = url_list[index]["title"];
      document.getElementById("viewCount").innerText = parseInt(url_list[index]["viewCount"]).toString();
    } else {
      downloadCSV({filename: "progress.csv"});
    }
    document.getElementById("totalVideosTagged").innerText = totalTagged.toString();
  }

  function clearAnswers() {
    let i;
    let choices = document.getElementsByClassName('checkbox');
    for (i = 0; i < choices.length; i++)
      choices[i].checked = false;


    let radio_choices = document.getElementsByClassName("radio");
    for (i = 0; i < radio_choices.length; i++)
      radio_choices[i].checked = false;

  }

  // Check that all questions have been answered
  function isCompleted() {
    let completed = true;
    let answer_list = [];

    let include_question = document.getElementsByName("q0");
    let hasCheckedInclude = false;
    for (i=0; i<include_question.length; i++){
      if (include_question[i].checked)
        hasCheckedInclude = true;
    }
    console.log(hasCheckedInclude);
    let isIncluded = include_question[0].checked;

    if (isIncluded){
      for(i = 0; i < NUMBER_OF_QUESTIONS; i++) {
        let answered = false;
        let choices = document.getElementsByName('q' + (i).toString());
        for (j = 0; j < choices.length; j++) {
          let c = choices[j]
          if (c.checked)
            answered = true;
        }
        answer_list.push(answered);
      }
      for (k = 0; k < answer_list.length; k++){
        if (!answer_list[k])
          completed = false;
      }
    }
    if (!isIncluded) // video is not included
      completed = true;

    if(completed && hasCheckedInclude){
      saveAnswers();
    }
    else if (!completed || !hasCheckedInclude){
      window.alert("Not all questions have been answered.");
    }
  }


  // function to calculate the result of the survey
  function saveAnswers() {
    let vid = url_list[currentIndex]["videoId"];
    if (vid == "#NAME?"){
      vid = url_list[currentIndex]["embedUrl"].split("https://www.youtube.com/embed/").pop();
    }
    tagging = {
      "embedUrl": url_list[currentIndex]["embedUrl"],
      "videoId": vid,
    };

    // FOR FIRST QUESTION (YES/NO)
    let choices = document.getElementsByName("q0");
    for (j = 0; j < choices.length; j++) {
      if (choices[j].checked) {
        tagging[FINAL_HEADER[0]] = choices[j].value;
      }
    }

    // FOR THE REST OF QUESTIONS 1-3 (Multiple choice)
    for (i=1; i<NUMBER_OF_QUESTIONS; i++){
      let choices = document.getElementsByName("q" + (i).toString());
      let answers_local = [];
      for (k=0; k<choices.length; k++){
        if (choices[k].checked)
          answers_local.push(choices[k].value);
      }
      tagging[FINAL_HEADER[i]] = "[" + answers_local.join(';') + "]";
    }

    answers.push(tagging);
    clearAnswers();
    currentIndex = currentIndex + 1;
    totalTagged++;
    updateVideoUrl(currentIndex);
  }

  function downloadCSV(args) {
    var data, filename, link;
    var csv = convertArrayOfObjectsToCSV({
      data: answers
    });
    if (csv == null) return;

    filename = args.filename || 'export.csv';

    if (!csv.match(/^data:text\/csv/i)) {
      csv = 'data:text/csv;charset=utf-8,' + csv;
    }
    data = encodeURI(csv);

    link = document.createElement('a');
    link.setAttribute('href', data);
    link.setAttribute('download', filename);
    link.click();
  }

  function convertArrayOfObjectsToCSV(args) {
    var result, ctr, keys, columnDelimiter, lineDelimiter, data;

    data = args.data || null;
    if (data == null || !data.length) {
      return null;
    }

    columnDelimiter = args.columnDelimiter || ',';
    lineDelimiter = args.lineDelimiter || '\n';

    keys = Object.keys(data[0]);

    result = '';
    result += keys.join(columnDelimiter);
    result += lineDelimiter;

    data.forEach(function (item) {
      ctr = 0;
      keys.forEach(function (key) {
        if (ctr > 0) result += columnDelimiter;

        result += item[key];
        ctr++;
      });
      result += lineDelimiter;
    });

    return result;
  }
</script>
</body>
</html>
